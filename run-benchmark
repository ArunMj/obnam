#!/bin/sh
#
# Copyright 2010, 2011  Lars Wirzenius
# 
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

set -e

die()
{
    echo "$@" 1>&2
    exit 1
}

SEIVOTDIR=$HOME/seivot/make-flexible
OBNAM_BRANCH="."
LARCH_BRANCH="$HOME/larch/trunk"
SIZES="1g/100m 10g/1g 100g/10g"
WIKI="$HOME/braawi.org"
GENERATIONS=5

if [ $# -ge 1 ]
then
    OBNAM_BRANCH="$1"
    shift
fi

if [ $# -ge 1 ]
then
    LARCH_BRANCH="$1"
    shift
fi

if [ $# -ge 1 ]
then
    SIZES="$1"
    shift
fi

if [ $# -ge 1 ]
then
    WIKI="$1"
    shift
fi

if [ $# -ge 1 ]
then
    SEIVOT="$1"
    shift
fi

if [ $# != 0 ]
then
    die "Usage: $0 [obnam-branch [larch-branch [sizes [wiki-root [path/to/seivot]]]]]"
fi

if [ "x$TMPDIR" = x ]
then
    die "TMPDIR is not set. You'll probably run out of space on /tmp..."
fi

OBNAM_REVNO=$(cd "$OBNAM_BRANCH" && bzr revno)
LARCH_REVNO=$(cd "$LARCH_BRANCH" && bzr revno)

RESULTS="$WIKI/obnam/benchmarks/$OBNAM_REVNO-$LARCH_REVNO"
[ -e "$RESULTS" ] && die "$RESULTS already exists"
mkdir "$RESULTS"
for pair in $SIZES
do
    size=$(echo "$pair" | sed 's:/.*::')
    inc=$(echo "$pair" | sed 's:.*/::')
    echo "Benchmark run for size $size inc $inc"
    
    $SEIVOTDIR/seivot \
        --obnam-branch="$OBNAM_BRANCH" \
        --larch-branch="$LARCH_BRANCH" \
        --initial-data="$size" \
        --incremental-data="$inc" \
        --obnam-profile="$RESULTS/obnam-$size-%(op)s-%(gen)s-%(order)s.txt" \
        --generations="$GENERATIONS" \
        --output="$RESULTS/obnam-$size.seivot"
done

$SEIVOTDIR/seivots-to-csv "$RESULTS"/../*/*.seivot --output-dir "$RESULTS/.."

