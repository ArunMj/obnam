#!/usr/bin/make -f

P = obnam

build:
	$(MAKE)

binary: checkversion binary-arch binary-indep

binary-arch: build
	rm -rf debian/tmp
	install -d debian/tmp debian/tmp/DEBIAN
	install -d debian/tmp/usr/bin
	install -d debian/tmp/usr/share/doc/$P
	strip --strip-unneeded -R .note -R .comment odirect_read
	$(MAKE) prefix=debian/tmp/usr etcdir=debian/tmp/etc install
	gzip -9 debian/tmp/usr/share/man/man1/*
	sed -i 's,^#!/usr/sbin/python$$,&2.4,' debian/tmp/usr/bin/obnam
	install -m 0644 debian/changelog \
	    debian/tmp/usr/share/doc/$P/changelog.Debian
	install -m 0644 NEWS debian/tmp/usr/share/doc/$P/changelog
	install -m 0644 README debian/tmp/usr/share/doc/$P
	gzip -9 debian/tmp/usr/share/doc/$P/*
	install -m 0644 debian/copyright debian/tmp/usr/share/doc/$P
	dpkg-gencontrol -isp
	chown -R root:root debian/tmp
	chmod -R o-s,go=u,go-ws debian/tmp
	dpkg --build debian/tmp ..

binary-indep:

clean:
	$(MAKE) clean
	rm -rf debian/files debian/substvars debian/tmp

checkversion:
	v1=$$(sed -n '/^VERSION = /s/.*"\(.*\)".*/\1/p' cli.py); \
	v2=$$(dpkg-parsechangelog|sed -n 's/^Version: \(.*\)-[^-]*$$/\1/p'); \
	if [ "$$v1" != "$$v2" ]; then \
	    echo "Upstream version $$v1 != Debian version $$v2"; exit 1; fi
