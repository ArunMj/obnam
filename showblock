#!/usr/bin/python


"""Show the contents of a Wibbr storage block."""


import sys

from wibbrlib import *


recursive_component_types = (
    CMP_OBJPART,
    CMP_NAMEIPAIR,
)


def format_objmap(data):
    uuids = []
    while data:
        uuids.append(data[:36])
        data = data[36:]
    return "%s -> %s" % (uuids[0], ",".join(uuids[1:]))


def format_octal(data):
    return "0%o" % varint_decode(data, 0)[0]


def format_decimal(data):
    return "%d" % varint_decode(data, 0)[0]
    

component_data_formatters = {
    CMP_OBJTYPE: lambda data: object_type_name(varint_decode(data, 0)[0]),
    CMP_ST_MODE: format_octal,
    CMP_ST_INO: format_decimal,
    CMP_ST_DEV: format_decimal,
    CMP_ST_NLINK: format_decimal,
    CMP_ST_UID: format_decimal,
    CMP_ST_GID: format_decimal,
    CMP_ST_SIZE: format_decimal,
    CMP_ST_ATIME: format_decimal,
    CMP_ST_CTIME: format_decimal,
    CMP_ST_MTIME: format_decimal,
    CMP_ST_BLOCKS: format_decimal,
    CMP_ST_BLKSIZE: format_decimal,
    CMP_ST_RDEV: format_decimal,
    CMP_OBJMAP: format_objmap,
}


def show_component(type, data, indent=0):
    x = " " * (indent * 2)
    print x + "Component:", type, component_type_name(type)
    if type in recursive_component_types:
        pos = 0
        while pos < len(data):
            (type2, data2, pos) = component_decode(data, pos)
            show_component(type2, data2, indent+1)
    else:
        fmt = component_data_formatters.get(type, repr)
        print x + "  data:", fmt(data)


def show_block(filename):
    print "======== block:", filename, "==========="
    f = file(filename, "r")
    str = f.read()
    f.close()
    pos = 0
    while pos < len(str):
        (type, data, pos) = component_decode(str, pos)
        show_component(type, data)
        print


def main():
    for filename in sys.argv[1:]:
        show_block(filename)


if __name__ == "__main__":
    main()
